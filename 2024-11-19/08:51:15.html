<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-touch-icon-167x167.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icons/apple-touch-icon-512x512.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>divefree: Kealakekua Bay</title>
    <script src="/plotly-basic.min.js"></script>
    <style>
        html {
          height: 100%;
          margin: 0;
          overflow: hidden;
        }
        body {
          height: 100%;
          font-family: Arial, sans-serif;
          color: #555;
          overflow-y: auto;
          overflow-x: hidden;
        }
        #divePlot {
          width: 100%;
        }
        #mapPane {
          width: 100%;
        }
    </style>
  </head>
  <body>
    
    <div id="divePlot"></div>
    
    <br/>

    <div id="mapPane">
      <center>
        <iframe
            id="mapIframe"
            width="70%"
            height="200px"
            loading="lazy"
            frameborder="0"
            scrolling="no"
            src="https://www.openstreetmap.org/export/embed.html?bbox=-0.1%2C-0.1%2C0.1%2C0.1&marker=0,0">
        </iframe>
      </center>
    </div>
    
    <script>
      const title = '';
      const xlabel = 'time (s)';
      const ylabel1 = 'depth (m)';
      const ylabel2 = 'rate (m/s)';
      const color1 = 'royalblue';
      const color2 = 'darkgrey';
      const dataset = {
        date: "2024-11-19",
        time: "08:51:15",
        lat: 19.481084,
        lon: -155.932112,
        locname: "Kealakekua Bay",
        t: [0,0.25,0.5,0.75,1,1.25,1.5,1.75,2,2.25,2.5,2.75,3,3.25,3.5,3.75,4,4.25,4.5,4.75,5,5.25,5.5,5.75,6,6.25,6.5,6.75,7,7.25,7.5,7.75,8,8.25,8.5,8.75,9,9.25,9.5,9.75,10,10.25,10.5,10.75,11,11.25,11.5,11.75,12,12.25,12.5,12.75,13,13.25,13.5,13.75,14,14.25,14.5,14.75,15,15.25,15.5,15.75,16,16.25,16.5,16.75,17,17.25,17.5,17.75,18,18.25,18.5,18.75,19,19.25,19.5,19.75,20,20.25,20.5,20.75,21,21.25,21.5,21.75,22,22.25,22.5,22.75,23,23.25,23.5,23.75,24,24.25,24.5,24.75,25,25.25,25.5,25.75,26,26.25,26.5,26.75,27,27.25,27.5,27.75,28,28.25,28.5,28.75,29,29.25,29.5,29.75,30,30.25,30.5,30.75,31,31.25,31.5,31.75,32,32.25,32.5,32.75,33,33.25,33.5,33.75,34,34.25,34.5,34.75,35,35.25,35.5,35.75,36,36.25,36.5,36.75,37,37.25,37.5,37.75,38,38.25,38.5,38.75,39],
        depth: [-0.03,-0.01,-0.47,-0.6,-0.39,-0.71,-1.04,-0.99,-1.23,-1.86,-1.92,-2.01,-2.1,-2.19,-2.27,-2.38,-2.54,-2.66,-2.77,-2.91,-2.98,-3.1,-3.25,-3.35,-3.45,-3.56,-3.62,-3.69,-3.74,-3.78,-3.8,-3.83,-3.84,-3.84,-3.83,-3.8,-3.76,-3.75,-3.75,-3.72,-3.73,-3.77,-3.8,-3.83,-3.83,-3.88,-3.94,-3.98,-4.02,-4.06,-4.1,-4.1,-4.12,-4.14,-4.15,-4.17,-4.16,-4.15,-4.15,-4.14,-4.16,-4.13,-4.14,-4.14,-4.14,-4.16,-4.15,-4.12,-4.14,-4.12,-4.08,-4.07,-4.06,-4.04,-4.03,-4.05,-4.11,-4.16,-4.22,-4.31,-4.36,-4.43,-4.57,-4.66,-4.8,-4.87,-4.93,-4.98,-4.97,-4.96,-4.97,-4.92,-4.91,-4.88,-4.83,-4.78,-4.72,-4.66,-4.63,-4.62,-4.61,-4.6,-4.55,-4.48,-4.43,-4.35,-4.33,-4.28,-4.24,-4.22,-4.12,-4.02,-4.09,-4.03,-3.86,-3.9,-4.04,-3.87,-3.57,-3.54,-3.46,-3.34,-3.01,-2.86,-2.78,-2.63,-2.58,-2.51,-2.25,-2,-1.74,-1.46,-1.26,-1.02,-0.74,-0.43,-0.14,-0.09,-0.04,-0.06,-0.32,-0.34,-0.13,-0.27,-0.33,-0.08,-0.03,-0.02,0.02,-0.04,-0.46,-0.22,-0.28,-0.35,-0.24,-0.3,-0.39],
        temperature: ["27.40","27.40","27.30","27.30","27.30","27.30","27.30","27.30","27.30","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.20","27.10","27.10","27.10","27.10","27.10","27.10","27.10","27.10","27.10","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00","27.00"],
        vertrates: [0.08,-0.496,-0.5032,-0.10024,-0.454168,-0.7139176,-0.43974232,-0.595819624,-1.1730737368,-0.89315161576,-0.733206131032,-0.6212442917224,-0.54287100420568,-0.476009702943976,-0.465206792060783,-0.517644754442548,-0.506351328109784,-0.486445929676848,-0.508512150773794,-0.439958505541656,-0.451970953879159,-0.496379667715411,-0.467465767400788,-0.447226037180552,-0.445058226026386,-0.38354075821847,-0.352478530752929,-0.306734971527051,-0.262714480068935,-0.207900136048254,-0.181530095233778,-0.139071066663645,-0.0973497466645512,-0.0561448226651861,-0.00330137586562995,0.0456890368940591,0.0439823258258411,0.0307876280780888,0.0575513396546624,0.0282859377582634,-0.0281998435692156,-0.0557398904984507,-0.0750179233489158,-0.0525125463442411,-0.0967587824409685,-0.139731147708678,-0.145811803396075,-0.150068262377252,-0.153047783664076,-0.155133448564853,-0.108593413995397,-0.100015389796779,-0.0940107728577446,-0.077807541000422,-0.0784652787002949,-0.0429256950902067,-0.0180479865631449,-0.0126335905942015,0.00315648658405979,-0.0217904593911587,0.0207466784261892,0.0025226748983327,0.00176587242883289,0.00123611070018302,-0.0231347225098724,-0.00419430575691096,0.0330639859701626,-0.000855209820885654,0.0234013531253795,0.0643809471877657,0.0570666630314357,0.0519466641220058,0.0603626648854036,0.0542538654197822,0.0139777057938481,-0.0622156059443069,-0.103550924161015,-0.14448564691271,-0.209139952838897,-0.206397966987229,-0.228478576891059,-0.327935003823742,-0.337554502676619,-0.404288151873633,-0.367001706311543,-0.32890119441808,-0.290230836092657,-0.191161585264859,-0.121813109685402,-0.0972691767797808,-0.00808842374584676,0.00633810337790701,0.0404366723645352,0.0883056706551744,0.121813969458622,0.157269778621036,0.182088845034725,0.163462191524308,0.126423534067015,0.10049647384691,0.082347531692838,0.117643272184986,0.16635029052949,0.176445203370644,0.219511642359451,0.177658149651615,0.18436070475613,0.177052493329291,0.147936745330504,0.223555721731353,0.276489005211947,0.109542303648363,0.148679612553854,0.308075728787698,0.167653010151388,-0.0506428928940282,0.16854997497418,0.477984982481926,0.370589487737348,0.355412641416144,0.392788848991301,0.670952194293911,0.649666536005737,0.550766575204016,0.565536602642811,0.455875621849968,0.403112935294978,0.594179054706484,0.715925338294539,0.813147736806177,0.905203415764324,0.873642391035027,0.899549673724519,0.965684771607163,1.04797934012501,1.08158553808751,0.817109876661257,0.63197691366288,0.418383839564016,-0.0191313123051891,-0.0373919186136324,0.225825656970457,-0.00992204012067988,-0.0789454280844759,0.244738200340867,0.231316740238607,0.173921718167025,0.169745202716917,0.0468216419018421,-0.471224850668711,-0.0418573954680973,-0.101300176827668,-0.154910123779368,0.0235629133544427,-0.0555059606518902,-0.146854172456323,-0.210797920719426]
      };
      function updatePlot() {

        function formatTime(seconds) {
          const minutes = Math.floor(seconds / 60);  // Get full minutes
          const sec = seconds % 60;  // Get the fractional part of the seconds

          // Check if the fractional part is zero
          if (sec % 1 === 0) {
            return `${minutes.toString().padStart(2, '0')}:${Math.floor(sec).toString().padStart(2, '0')}`; // No decimal part if it's zero
          } else {
            return `${minutes.toString().padStart(2, '0')}:${sec.toFixed(2).padStart(5, '0')}`; // With fractional seconds
          }
        }

        // Calculate the time difference (dt) between the first two timestamps
        var dt = dataset.t[1] - dataset.t[0];
        
        dataset.t = dataset.t.map(formatTime);

        // Calculate the number of samples needed to cover 5 seconds
        var tickInterval = Math.round(5 / dt);
        var tickVals = dataset.t.filter((time, index) => index % tickInterval === 0);
        var tickText = tickVals;

        var colors = dataset.vertrates.map(rate => {
          if (rate < 0) {
            return 'darkgrey';
          } else return 'lightgrey';
        });

        Plotly.react('divePlot', [
          {
            x: dataset.t,
            y: dataset.depth,
            mode: 'lines',
            type: 'scatter',
            name: ylabel1,
            yaxis: 'y',
            line: { color: color1 },
            zorder: 2
          },
          {
            x: dataset.t,
            y: dataset.vertrates,
            mode: 'lines',
            type: 'bar',
            name: ylabel2,
            yaxis: 'y2',
            marker: { color: colors },
            zorder: 1
          }
        ], {
          title: dataset.date + " // " + dataset.time + " // " + dataset.locname,
          showlegend: false,
          xaxis: { 
            title: xlabel,
            tickvals: tickVals,
            ticktext: tickText
          },
          yaxis: { title: ylabel1, side: 'left', titlefont: { color: color1 }, tickfont: { color: color1 } },
          yaxis2: {
            title: ylabel2,
            overlaying: 'y',
            side: 'right',
            titlefont: { color: color2 },
            tickfont: { color: color2 },
            showgrid: false // Optional: Hide the grid for the right Y-axis
          }
        });

        // Update the iframe URL with new coordinates and bbox
        const lat = dataset.lat;
        const lon = dataset.lon;
        if (lat && lon ){
          const newBBox = `${lon - 0.03}%2C${lat - 0.03}%2C${lon + 0.03}%2C${lat + 0.03}`;
          const newMarker = `${lat},${lon}`;
          const newIframeSrc = `https://www.openstreetmap.org/export/embed.html?bbox=${newBBox}&marker=${newMarker}`;
          document.getElementById('mapIframe').src = newIframeSrc;
        }else{
          document.getElementById('mapIframe').src = ``;
        }
      }

      // Initial plot with the first dataset
      updatePlot();

      window.addEventListener('resize', function() {
        Plotly.Plots.resize(document.getElementById('divePlot'));
      });

    </script>
  </body>
</html>
