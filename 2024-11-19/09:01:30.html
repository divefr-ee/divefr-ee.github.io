<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-touch-icon-167x167.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icons/apple-touch-icon-512x512.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>divefree: Kealakekua Bay</title>
    <script src="/plotly-basic.min.js"></script>
    <style>
        html {
          height: 100%;
          margin: 0;
          overflow: hidden;
        }
        body {
          height: 100%;
          font-family: Arial, sans-serif;
          color: #555;
          overflow-y: auto;
          overflow-x: hidden;
        }
        #divePlot {
          width: 100%;
        }
        #mapPane {
          width: 100%;
        }
    </style>
  </head>
  <body>
    
    <div id="divePlot"></div>
    
    <br/>

    <div id="mapPane">
      <center>
        <iframe
            id="mapIframe"
            width="70%"
            height="200px"
            loading="lazy"
            frameborder="0"
            scrolling="no"
            src="https://www.openstreetmap.org/export/embed.html?bbox=-0.1%2C-0.1%2C0.1%2C0.1&marker=0,0">
        </iframe>
      </center>
    </div>
    
    <script>
      const title = '';
      const xlabel = 'time (s)';
      const ylabel1 = 'depth (m)';
      const ylabel2 = 'rate (m/s)';
      const color1 = 'royalblue';
      const color2 = 'darkgrey';
      const dataset = {
        date: "2024-11-19",
        time: "09:01:30",
        lat: 19.481084,
        lon: -155.932112,
        locname: "Kealakekua Bay",
        t: [0,0.25,0.5,0.75,1,1.25,1.5,1.75,2,2.25,2.5,2.75,3,3.25,3.5,3.75,4,4.25,4.5,4.75,5,5.25,5.5,5.75,6,6.25,6.5,6.75,7,7.25,7.5,7.75,8,8.25,8.5,8.75,9,9.25,9.5,9.75,10,10.25,10.5,10.75,11,11.25,11.5,11.75,12,12.25,12.5,12.75,13,13.25,13.5,13.75,14,14.25,14.5,14.75,15,15.25,15.5,15.75,16,16.25,16.5,16.75,17,17.25,17.5,17.75,18,18.25,18.5,18.75,19,19.25,19.5,19.75,20,20.25,20.5,20.75,21,21.25,21.5,21.75,22,22.25,22.5,22.75,23,23.25,23.5,23.75,24,24.25,24.5,24.75,25,25.25,25.5,25.75,26,26.25,26.5,26.75,27,27.25,27.5,27.75,28,28.25,28.5,28.75,29,29.25,29.5,29.75,30,30.25,30.5,30.75,31,31.25,31.5,31.75,32,32.25,32.5,32.75,33,33.25,33.5,33.75,34,34.25,34.5,34.75,35,35.25,35.5,35.75,36,36.25,36.5,36.75,37,37.25,37.5,37.75,38,38.25,38.5,38.75,39,39.25,39.5,39.75,40],
        depth: [-0.36,-1.04,-1.4,-0.85,-0.34,-0.91,-1.41,-0.87,-1.17,-1.79,-2.04,-2.13,-2.18,-2.31,-2.4,-2.48,-2.53,-2.61,-2.68,-2.78,-2.92,-3.03,-3.13,-3.26,-3.34,-3.44,-3.52,-3.61,-3.67,-3.74,-3.81,-3.86,-3.93,-3.97,-4.01,-4.05,-4.07,-4.11,-4.11,-4.1,-4.13,-4.15,-4.17,-4.24,-4.27,-4.33,-4.4,-4.46,-4.49,-4.53,-4.6,-4.64,-4.66,-4.69,-4.7,-4.74,-4.77,-4.85,-4.77,-4.42,-4.62,-4.68,-4.61,-4.67,-4.98,-4.99,-5.09,-5.25,-4.83,-4.92,-5.1,-5.21,-5.18,-5.45,-5.68,-5.69,-5.66,-5.67,-5.65,-5.65,-5.66,-5.67,-5.69,-5.69,-5.74,-5.78,-5.8,-5.84,-5.87,-5.93,-5.93,-5.92,-5.95,-5.97,-5.96,-6.06,-5.89,-5.82,-5.85,-5.95,-5.77,-5.6,-5.53,-5.5,-5.34,-5.22,-5.11,-5.12,-5.09,-5,-5.29,-5.23,-5.01,-4.86,-4.93,-4.77,-4.54,-4.76,-4.54,-4.32,-4.42,-4.23,-4.05,-4.07,-4.15,-3.96,-3.76,-3.62,-3.37,-3.15,-2.85,-2.63,-2.41,-2.08,-1.86,-1.59,-1.33,-1.08,-0.74,-0.34,-0.03,-0.08,-0.02,0.07,-0.39,-0.25,-0.15,-0.1,-0.13,-0.31,-0.45,-0.43,-0.25,-0.13,-0.11,-0.22,-0.18,-0.23,-0.29,-0.16,-0.12],
        temperature: ["26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.60","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.70","26.60","26.70","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.70","26.60","26.70","26.60","26.70","26.60","26.70","26.70","26.70","26.70","26.70","26.60","26.70","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60","26.60"],
        vertrates: [-2.72,-2.336,-0.9752,-0.0706399999999998,-0.733448,-1.1134136,-0.13138952,-0.451972664,-1.0603808648,-1.04226660536,-0.837586623752,-0.6463106366264,-0.60841744563848,-0.533892211946936,-0.469724548362855,-0.388807183853999,-0.368165028697799,-0.341715520088459,-0.359200864061922,-0.419440604843345,-0.425608423390341,-0.417925896373239,-0.448548127461267,-0.409983689222887,-0.406988582456021,-0.380892007719215,-0.37462440540345,-0.334237083782415,-0.317965958647691,-0.306576171053383,-0.274603319737368,-0.276222323816158,-0.24135562667131,-0.216948938669917,-0.199864257068942,-0.16390497994826,-0.162733485963782,-0.113913440174647,-0.0677394081222524,-0.0834175856855769,-0.0823923099799044,-0.0816746169859326,-0.141172231890153,-0.134820562323106,-0.166374393626175,-0.200462075538323,-0.212323452876826,-0.184626417013778,-0.177238491909645,-0.208066944336751,-0.193646861035725,-0.159552802725008,-0.147686961907506,-0.115380873335254,-0.128766611334678,-0.126136627934274,-0.184295639553992,-0.0330069476877941,0.396895136618544,0.0378265956329803,-0.0455213830569133,0.0521350318601599,-0.0355054776978876,-0.396853834388522,-0.289797684071965,-0.322858378850375,-0.418000865195263,0.211399394363316,0.0399795760543214,-0.188014296761975,-0.263610007733383,-0.148527005413368,-0.427968903789358,-0.57557823265255,-0.414904762856786,-0.25443333399975,-0.190103333799824,-0.109072333659878,-0.0763506335619143,-0.0654454434933398,-0.0578118104453376,-0.0644682673117369,-0.0451277871182158,-0.0915894509827508,-0.112112615687926,-0.102478830981547,-0.119735181687083,-0.119814627180959,-0.155870239026671,-0.109109167318669,-0.0643764171230688,-0.0810634919861485,-0.0807444443903034,-0.0445211110732126,-0.151164777751248,0.098184655574126,0.152729258901887,0.070910481231322,-0.0703626631380752,0.166746135803348,0.320722295062344,0.30850560654364,0.251953924580548,0.368367747206384,0.401857423044469,0.413300196131127,0.277310137291789,0.230117096104253,0.269081967272977,-0.159642622908916,-0.0397498360362419,0.236175114774631,0.345322580342241,0.15772580623957,0.302408064367699,0.487685645057389,0.0773799515401724,0.31816596607812,0.486716176254684,0.220701323378279,0.382490926364795,0.483743648455357,0.314620553918749,0.124234387743124,0.314964071420188,0.460474849994131,0.490332394995892,0.643232676497124,0.714262873547987,0.859984011483591,0.865988808038514,0.870192165626959,1.00513451593887,0.96759416115721,1.00131591281005,1.01292113896703,1.00904479727692,1.11433135809385,1.26003195066569,1.25402236546598,0.817815655826189,0.644470959078332,0.559129671354832,-0.160609230051617,0.0555735389638678,0.158901477274707,0.171231034092295,0.0838617238646066,-0.157296793294775,-0.278107755306343,-0.17067542871444,0.0965271998998921,0.211569039929924,0.172098327950947,-0.011531170434337,0.0399281806959641,-0.0320502735128252,-0.0944351914589776,0.0898953659787157,0.110926756185101,0.125648729329571]
      };
      function updatePlot() {

        function formatTime(seconds) {
          const minutes = Math.floor(seconds / 60);  // Get full minutes
          const sec = seconds % 60;  // Get the fractional part of the seconds

          // Check if the fractional part is zero
          if (sec % 1 === 0) {
            return `${minutes.toString().padStart(2, '0')}:${Math.floor(sec).toString().padStart(2, '0')}`; // No decimal part if it's zero
          } else {
            return `${minutes.toString().padStart(2, '0')}:${sec.toFixed(2).padStart(5, '0')}`; // With fractional seconds
          }
        }

        // Calculate the time difference (dt) between the first two timestamps
        var dt = dataset.t[1] - dataset.t[0];
        
        dataset.t = dataset.t.map(formatTime);

        // Calculate the number of samples needed to cover 5 seconds
        var tickInterval = Math.round(5 / dt);
        var tickVals = dataset.t.filter((time, index) => index % tickInterval === 0);
        var tickText = tickVals;

        var colors = dataset.vertrates.map(rate => {
          if (rate < 0) {
            return 'darkgrey';
          } else return 'lightgrey';
        });

        Plotly.react('divePlot', [
          {
            x: dataset.t,
            y: dataset.depth,
            mode: 'lines',
            type: 'scatter',
            name: ylabel1,
            yaxis: 'y',
            line: { color: color1 },
            zorder: 2
          },
          {
            x: dataset.t,
            y: dataset.vertrates,
            mode: 'lines',
            type: 'bar',
            name: ylabel2,
            yaxis: 'y2',
            marker: { color: colors },
            zorder: 1
          }
        ], {
          title: dataset.date + " // " + dataset.time + " // " + dataset.locname,
          showlegend: false,
          xaxis: { 
            title: xlabel,
            tickvals: tickVals,
            ticktext: tickText
          },
          yaxis: { title: ylabel1, side: 'left', titlefont: { color: color1 }, tickfont: { color: color1 } },
          yaxis2: {
            title: ylabel2,
            overlaying: 'y',
            side: 'right',
            titlefont: { color: color2 },
            tickfont: { color: color2 },
            showgrid: false // Optional: Hide the grid for the right Y-axis
          }
        });

        // Update the iframe URL with new coordinates and bbox
        const lat = dataset.lat;
        const lon = dataset.lon;
        if (lat && lon ){
          const newBBox = `${lon - 0.03}%2C${lat - 0.03}%2C${lon + 0.03}%2C${lat + 0.03}`;
          const newMarker = `${lat},${lon}`;
          const newIframeSrc = `https://www.openstreetmap.org/export/embed.html?bbox=${newBBox}&marker=${newMarker}`;
          document.getElementById('mapIframe').src = newIframeSrc;
        }else{
          document.getElementById('mapIframe').src = ``;
        }
      }

      // Initial plot with the first dataset
      updatePlot();

      window.addEventListener('resize', function() {
        Plotly.Plots.resize(document.getElementById('divePlot'));
      });

    </script>
  </body>
</html>
