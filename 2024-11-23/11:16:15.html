<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-touch-icon-167x167.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icons/apple-touch-icon-512x512.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>divefree: Ulua Beach</title>
    <script src="/plotly-basic.min.js"></script>
    <style>
        html {
          height: 100%;
          margin: 0;
          overflow: hidden;
        }
        body {
          height: 100%;
          font-family: Arial, sans-serif;
          color: #555;
          overflow-y: auto;
          overflow-x: hidden;
        }
        #divePlot {
          width: 100%;
        }
        #mapPane {
          width: 100%;
        }
    </style>
  </head>
  <body>
    
    <div id="divePlot"></div>
    
    <br/>

    <div id="mapPane">
      <center>
        <iframe
            id="mapIframe"
            width="70%"
            height="200px"
            loading="lazy"
            frameborder="0"
            scrolling="no"
            src="https://www.openstreetmap.org/export/embed.html?bbox=-0.1%2C-0.1%2C0.1%2C0.1&marker=0,0">
        </iframe>
      </center>
    </div>
    
    <script>
      const title = '';
      const xlabel = 'time (s)';
      const ylabel1 = 'depth (m)';
      const ylabel2 = 'rate (m/s)';
      const color1 = 'royalblue';
      const color2 = 'grey';
      const dataset = {
        date: "2024-11-23",
        time: "11:16:15",
        lat: 20.68886,
        lon: -156.4443,
        locname: "Ulua Beach",
        t: [0,0.25,0.5,0.75,1,1.25,1.5,1.75,2,2.25,2.5,2.75,3,3.25,3.5,3.75,4,4.25,4.5,4.75,5,5.25,5.5,5.75,6,6.25,6.5,6.75,7,7.25,7.5,7.75,8,8.25,8.5,8.75,9,9.25,9.5,9.75,10,10.25,10.5,10.75,11,11.25,11.5,11.75,12,12.25,12.5,12.75,13,13.25,13.5,13.75,14,14.25,14.5,14.75,15,15.25,15.5,15.75,16,16.25,16.5,16.75,17,17.25,17.5,17.75,18,18.25,18.5,18.75,19,19.25,19.5,19.75,20],
        depth: [-0.38,-0.23,-0.45,-0.22,-0.66,-0.74,-0.46,-0.49,-0.7,-1.49,-1.08,-0.77,-1.03,-1.74,-1.6,-1.34,-1.4,-1.59,-1.74,-1.64,-1.56,-1.4,-1.46,-1.47,-1.69,-1.57,-1.48,-1.63,-1.54,-1.73,-1.58,-1.4,-1.54,-1.64,-1.74,-1.23,-1.11,-1.31,-1.53,-1.67,-1.52,-1.09,-1.35,-1.53,-1.43,-0.91,-1.03,-1.2,-1.27,-1.45,-1.63,-1.58,-1.52,-1.43,-1.37,-1.3,-1.25,-1.15,-0.99,-0.82,-0.69,-0.53,-0.46,-0.5,-0.38,-0.33,-0.23,-0.24,-0.25,-0.28,-0.32,-0.32,-0.33,-0.34,-0.3,-0.28,-0.27,-0.31,-0.33,-0.4,-0.48],
        temperature: ["26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20","26.20"],
        vertrates: [0.6,0.156,0.3852,-0.25836,-0.276852,0.1422036,0.06354252,-0.207520236,-1.0932641652,-0.27328491564,0.180700559052,-0.1855096086636,-0.98185672606452,-0.519299708245164,-0.0515097957716148,-0.10805685704013,-0.303639799928091,-0.392547859949664,-0.154783501964765,-0.0123484513753353,0.183356084037265,0.0563492588260857,0.02744448117826,-0.244788863175218,-0.0273522042226527,0.0888534570441432,-0.1178025800691,0.0255381939516301,-0.210123264233859,0.0329137150362987,0.239039600525409,-0.000672279632213668,-0.12047059574255,-0.204329417019785,0.468969408086151,0.472278585660305,0.0905950099622138,-0.20058349302645,-0.308408445118515,-0.0358859115829606,0.490879861891927,0.0316159033243492,-0.193868867672955,-0.0157082073710687,0.613004254840252,0.285102978388176,-0.00442791512827656,-0.0870995405897937,-0.276969678412855,-0.409878774888999,-0.226915142422299,-0.0868405996956094,0.0472115802130735,0.105048106149151,0.157533674304406,0.170273572013084,0.239191500409159,0.359434050286411,0.455603835200488,0.474922684640341,0.524445879248239,0.451112115473767,0.267778480831637,0.331444936582146,0.292011455607502,0.324408018925251,0.215085613247676,0.138559929273373,0.0609919504913612,-0.00530563465604713,-0.00371394425923299,-0.0145997609814631,-0.0222198326870242,0.032446117119083,0.0467122819833582,0.0446985973883507,-0.0167109818281545,-0.0356976872797082,-0.108988381095796,-0.172291866767057,-0.21660430673694]
      };
      function updatePlot() {

        function formatTime(seconds) {
          const minutes = Math.floor(seconds / 60);  // Get full minutes
          const sec = seconds % 60;  // Get the fractional part of the seconds

          // Check if the fractional part is zero
          if (sec % 1 === 0) {
            return `${minutes.toString().padStart(2, '0')}:${Math.floor(sec).toString().padStart(2, '0')}`; // No decimal part if it's zero
          } else {
            return `${minutes.toString().padStart(2, '0')}:${sec.toFixed(2).padStart(5, '0')}`; // With fractional seconds
          }
        }

        // Calculate the time difference (dt) between the first two timestamps
        var dt = dataset.t[1] - dataset.t[0];
        
        dataset.t = dataset.t.map(formatTime);

        // Calculate the number of samples needed to cover 5 seconds
        var tickInterval = Math.round(5 / dt);
        var tickVals = dataset.t.filter((time, index) => index % tickInterval === 0);
        var tickText = tickVals;

        var colors = dataset.vertrates.map(rate => {
          if (rate < 0) {
            return 'dark'+color2;
          } else return 'light'+color2;
        });

        Plotly.react('divePlot', [
          {
            x: dataset.t,
            y: dataset.depth,
            mode: 'lines',
            type: 'scatter',
            name: ylabel1,
            yaxis: 'y',
            line: { color: color1 },
            zorder: 2
          },
          {
            x: dataset.t,
            y: dataset.vertrates,
            mode: 'lines',
            type: 'bar',
            name: ylabel2,
            yaxis: 'y2',
            marker: { color: colors },
            zorder: 1
          }
        ], {
          title: dataset.date + " // " + dataset.time + " // " + dataset.locname,
          showlegend: false,
          xaxis: { 
            title: xlabel,
            tickvals: tickVals,
            ticktext: tickText
          },
          yaxis: { title: ylabel1, side: 'left', titlefont: { color: color1 }, tickfont: { color: color1 } },
          yaxis2: {
            title: ylabel2,
            overlaying: 'y',
            side: 'right',
            titlefont: { color: color2 },
            tickfont: { color: color2 },
            showgrid: false 
          }
        });

        // Update the iframe URL with new coordinates and bbox
        const lat = dataset.lat;
        const lon = dataset.lon;
        if (lat && lon ){
          const newBBox = `${lon - 0.03}%2C${lat - 0.03}%2C${lon + 0.03}%2C${lat + 0.03}`;
          const newMarker = `${lat},${lon}`;
          const newIframeSrc = `https://www.openstreetmap.org/export/embed.html?bbox=${newBBox}&marker=${newMarker}`;
          document.getElementById('mapIframe').src = newIframeSrc;
        }else{
          document.getElementById('mapIframe').src = ``;
        }
      }

      // Initial plot with the first dataset
      updatePlot();

      window.addEventListener('resize', function() {
        Plotly.Plots.resize(document.getElementById('divePlot'));
      });

    </script>
  </body>
</html>
